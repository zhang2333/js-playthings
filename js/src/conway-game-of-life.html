<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Conway's Game of Life</title>
        <style>
            html, body { margin: 0; padding: 0; overflow: hidden; }
            /*#canvas {
                width: 100%;
                height: 100%;
            }*/
        </style>
    </head>
    <body>
        <canvas id="canvas">
        </canvas>
        <script>
            'use strict';

            var canvas = document.getElementById('canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 5;

            var cxt = canvas.getContext('2d');
            cxt.fillStyle = '#aaa';

            var board, lastGen = Date.now();
            // offset
            var ox = 0, oy = 0;
            // size of cell
            var cw = 12, ch = 12;
            var colSize = parseInt(canvas.width / (cw + 1));
            var rowSize = parseInt(canvas.height / (ch + 1));
            var firstTime = true, interval = 500, isPaused = false;

            function random(a, b) {
                if (b == undefined) {
                    b = a;
                    a = 0;
                }
                return parseInt(Math.random() * b + a);
            }

            function setCell(x, y, state) {
                state = state > 0 ? 1 : 0;
                board[y * colSize + x] = 1;
            }

            function resetBoard() {
                board = [];

                for(var i = 0; i < rowSize * colSize; i++) {
                    board.push(0);
                }
            }

            function init() {
                resetBoard();
                for(var i = 0; i < parseInt(rowSize * colSize / 5); i++) {
                    setCell(random(colSize), random(rowSize), 1);
                }
            }

            function next(board) {
                var grid = [], liveArr = [], deadArr = [];

                // transform board to 2d grid
                for (var i = 0; i < rowSize; i++) {
                    grid.push(board.slice(i * colSize, (i + 1) * colSize));
                }

                // check status
                for (var i = 0; i < rowSize; i++) {
                    for (var j = 0; j < colSize; j++) {
                        // count the live
                        var liveNum = 0;
                        for (var y = i - 1; y <= i + 1; y++) {
                            for(var x = j - 1; x <= j + 1; x++) {
                                if (x < 0 || y < 0 || y >= rowSize || (x == j && y == i)) {
                                    continue;
                                }
                                if (grid[y][x] > 0) {
                                    liveNum++;
                                }
                            }
                        }

                        // live or die
                        if (grid[i][j] === 0 && liveNum === 3) {
                            liveArr.push([j, i]);
                        } else if (liveNum !== 2 && liveNum !== 3) {
                            deadArr.push([j, i]);
                        }
                    }
                }

                // live
                liveArr.forEach(function (a) {
                    grid[a[1]][a[0]] = 1;
                });

                // dead
                deadArr.forEach(function (a) {
                    grid[a[1]][a[0]] = 0;
                });

                board = [];
                for (var i = 0; i < grid.length; i++) {
                    board = board.concat(grid[i]);
                }

                grid = liveArr = deadArr = null;

                return board;
            }

            function draw() {
                var x, y;
                for (var i = 0; i < board.length; i++) {
                    y = parseInt(i / colSize);
                    x = i % colSize;
                    if (board[i]) {
                        cxt.beginPath();
                        cxt.rect(x * (cw + 1) + ox, y * (ch + 1) + oy, cw, ch);
                        cxt.fill();
                    }
                }
            }

            function animate() {
                cxt.clearRect(0, 0, canvas.width, canvas.height);
                draw();
                if (!isPaused && (Date.now() - lastGen > interval || firstTime)) {
                    board = next(board);
                    lastGen = Date.now();
                    firstTime = false;
                }
                requestAnimationFrame(animate);
            }

            // handle events
            (function () {
                var dragging = false;
                function handleEvent(e) {
                    var x = Math.round(e.clientX * colSize / canvas.width);
                    var y = Math.round(e.clientY * rowSize / canvas.height);
                    setCell(x, y, 1);
                }

                canvas.onmousedown = function (e) {
                    dragging = true;
                    handleEvent(e);
                }

                canvas.onmouseup = function (e) {
                    dragging = false;
                    handleEvent(e);
                }

                canvas.onmousemove = function (e) {
                    if (!dragging) return;
                    handleEvent(e);
                }

                canvas.onclick = handleEvent;

                document.onkeydown = function (e) {
                    if (e.keyCode === 32) {
                        isPaused = !isPaused;
                    }

                    if (e.keyCode === 13) {
                        isPaused = true;
                        resetBoard();
                    }
                }
            })();

            init();
            animate();

            console.info('interaction:', 'click or press space(pause)/enter(drawing mode)');
        </script>
    </body>
</html>